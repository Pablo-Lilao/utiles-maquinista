<html>
    <head>
        <meta charset="utf-8">
        <title>Practicar señales</title>
        <meta name="description" content="Practicar señales ferroviarias">
        <link rel="stylesheeet" type="text/css" href="style.css">
        <script src="js/mercPel.js"></script>
        <script src="js/fundSigns.js"></script>
        <script>
            /*    
            @licstart  The following is the entire license notice for the 
            JavaScript code in this page.
    
            Copyright (C) 2021  Pablo Lilao Chinchilla
    
            The JavaScript code in this page is free software: you can
            redistribute it and/or modify it under the terms of the GNU
            General Public License (GNU GPL) as published by the Free Software
            Foundation, either version 3 of the License, or (at your option)
            any later version.  The code is distributed WITHOUT ANY WARRANTY;
            without even the implied warranty of MERCHANTABILITY or FITNESS
            FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
    
            As additional permission under GNU GPL version 3 section 7, you
            may distribute non-source (e.g., minimized or compacted) forms of
            that code without the copy of the GNU GPL normally required by
            section 4, provided you include this license notice and a URL
            through which recipients can access the Corresponding Source.   
    
    
            @licend  The above is the entire license notice
            for the JavaScript code in this page.
            */
        </script>
    </head>
    <body>
        <form id="init_questionnaire_form">
            <input type="radio" id="merc_pel" name="questions" value="merc_pel">
            <label for="merc_pel">Mercancías peligrosas</label><br>
            <input type="radio" id="fund" name="questions" value="fund" checked>
            <label for="fund">Señales fundamentales</label><br>
            <input type="radio" id="transitorias" name="questions" value="transitorias">
            <label for="transitorias">Señales transitorias</label><br>
        </form>
        <h1>Ponte a prueba</h1>
        <input id="startButton" type="button" onclick="start(this)" value="Comenzar"> 
        <div id="questions" style="display: none;">
            <div>
                <label>¿Qué representa esta señal?</label>
                <div>
                    <img id="img-senal" src="">
                </div>
                    
                <div>
                    <input type="button" onclick="toggleSolution()" value="Ver respuesta"> 
                    <label id="solucion" style="display: none;"></label>
                    <label id="sign-name" style="display: none;"></label>
                </div>
            </div>
            <div id="resultButtons" style="display: none;">
                <input type="button" onclick="next(false)" value="Fallo">
                <input type="button" onclick="next(true)" value="Acierto">  
            </div>
        </div>
        <div id="questionnaire-results" style="display: none;">
            <label>Aciertos: </label><label id="questionnaire-right-answers"></label>
            <label>Fallos: </label><label id="questionnaire-wrong-answers"></label>
            <label>Totales: </label><label id="questionnaire-total-answers"></label>
            <input type="button" onclick="restart()" value="Nuevo intento">  
        </div>
        <div>
            <h1>Historial</h1>
            <h2>¿Qué es esto?</h2>
            <p>Si te da pereza leer no hace falta que sigas, puedes seguir usando la aplicación como antes.</p>
            <p>Ahora cada vez que marques una respuesta como error esta web lo guardará en una cookie en tu navegador.</p>
            <p>Cada vez que entres en esta web, leeré la información de dicha cookie y por cada error que tengas en una pregunta será más probable que te la pregunte.</p>
            <p>Pero las cookies se pueden eliminar de distintas maneras, así que te doy la opción de guardar todos tus fallos en un fichero de texto.
                Así tienes un mejor control sobre tus datos, puedes descargarlo para utilizar esta wgiteb en otro navegador o dispositivo sin perder tu información.
            </p>
            <div>
                <label for="uploadHistory">Cargar historial desde fichero</label>
                <input type="file" id="uploadHistory" name="filename"> 
            </div>  
            <div><input type="button" onclick="downloadHistory()" value="Guardar historial en fichero">  </div>
        </div>
        <footer>
            <div>Copyright (C) 2021  Pablo Lilao Chinchilla</div>
            <div>GNU GPL version 3</div>
            <div hidden>Imágenes obtenidas de distintos libros de formación</div>
        </footer>
    </body>
    <script>
        var transitoriaSigns = [
            { name: "FF1B - Pág. 88", text: "Vía libre"},
            { name: "FF1C - Pág. 88", text: "Vía libre"},
            { name: "FF1D - Pág. 88", text: "Vía libre"},
            { name: "FF1E - Pág. 88", text: "Vía libre"},
            { name: "FF3D - Pág. 89", text: "Anuncio de precaución"},
            { name: "FF3E - Pág. 89", text: "Anuncio de precaución"},
            { name: "FF3F - Pág. 89", text: "Anuncio de precaución"},
            { name: "FF5C - Pág. 89", text: "Anuncio de parada"},
            { name: "FF5D - Pág. 89", text: "Anuncio de parada"},
            { name: "FF5E - Pág. 89", text: "Anuncio de parada"},
            { name: "FF7E - Pág. 90", text: "Parada"},
            { name: "FF7F - Pág. 90", text: "Parada"},
            { name: "FF7G - Pág. 90", text: "Parada"},
            { name: "FF7H - Pág. 90", text: "Parada"},
            { name: "FF8D - Pág. 91", text: "Rebase autorizado"},
            { name: "FF9A - Pág. 91", text: "Movimiento autorizado"},
            { name: "FF9B - Pág. 91", text: "Movimiento autorizado"},
            { name: "FF12A - Pág. 90", text: "Parada diferida"},
            { name: "FF12B - Pág. 90", text: "Parada diferida"},
            //INDICADORAS
            { name: "FI16 - Pág. 92", text: "Poste de punto protegido"},
            { name: "FI3E - Pág. 92", text: "Indicadora de dirección de día y noche, indicando vía directa."},
            { name: "FI3F - Pág. 92", text: "Indicadora de dirección de día y noche, indicando desvío a la izquierda."},
            { name: "FI3G - Pág. 92", text: "Indicadora de dirección de día y noche, indicando desvío a la derecha."},
            { name: "FI3H_2 - Pág. 92", text: "Indicadora de dirección de noche, indicando vía directa."},
            { name: "FI3H - Pág. 92", text: "Indicadora de dirección de día, indicando vía directa."},
            { name: "FI3I_2 - Pág. 92", text: "Indicadora de dirección de noche, indicando desvío hacia la izquierda."},
            { name: "FI3I - Pág. 92", text: "Indicadora de dirección de día, indicando desvío hacia la izquierda."},
            { name: "FI3J_2 - Pág. 92", text: "Indicadora de dirección de noche, indicando desvío hacia la derecha."},
            { name: "FI3J - Pág. 92", text: "Indicadora de dirección de día, indicando desvío hacia la derecha."},
            { name: "FI4E - Pág. 93", text: "Indicadora de posición de aguja de día, indicando vía directa."},
            { name: "FI4E_2 - Pág. 93", text: "Indicadora de posición de aguja de noche, indicando vía directa."},
            { name: "FI4F - Pág. 93", text: "Indicadora de posición de aguja de día, indicando desvío a la derecha."},
            { name: "FI4F_2 - Pág. 93", text: "Indicadora de posición de aguja de noche, indicando desvío a la derecha"},
            { name: "FI4G - Pág. 93", text: "Indicadora de posición de aguja de día, indicando desvío a la izquierda"},
            { name: "FI4G_2 - Pág. 93", text: "Indicadora de posición de aguja de noche, indicando desvío a la izquierda."},

            { name: "FI9D - Pág. 94", text: "Poste de punto protegido. Se instala a lo largo de la línea. La flecha indica la dirección en que se encuentra la estación más próxima."},
            //PORTÁTILES
            { name: "P4A - Pág. 102", text: "En maniobras Tirar"},
            { name: "P4B - Pág. 102", text: "En maniobras Tirar"},
            { name: "P4C - Pág. 102", text: "En maniobras Empujar"},
            { name: "P4D - Pág. 102", text: "En maniobras Empujar"},
            { name: "P4E - Pág. 102", text: "En maniobras Lanzar o empujar rápido"},
            { name: "P4F - Pág. 102", text: "En maniobras Lanzar o empujar rápido"},
            { name: "P4G - Pág. 102", text: "En maniobras Reducir la marcha o empujar despacio"},
            { name: "P4H - Pág. 102", text: "En maniobras Reducir la marcha o empujar despacio"},
            { name: "P4I - Pág. 102", text: "En maniobras Parar"},
            { name: "P4J - Pág. 102", text: "En maniobras Parar"},
            //PRUEBAS DE FRENO
            { name: "P5A - Pág. 103", text: "Apretar frenos"},
            { name: "P5B - Pág. 103", text: "Apretar frenos"},
            { name: "P5C - Pág. 103", text: "Apretar frenos"},
            { name: "P5D - Pág. 103", text: "Aflojar frenos"},
            { name: "P5E - Pág. 103", text: "Aflojar frenos"},
            { name: "P5F - Pág. 103", text: "Aflojar frenos"},
            { name: "P5G - Pág. 103", text: "Prueba de frenos Terminada"},
            { name: "P5H - Pág. 103", text: "Prueba de frenos Terminada"},
            { name: "P5I - Pág. 103", text: "Prueba de frenos Terminada"},
            { name: "P5J - Pág. 103", text: "Prueba de frenos Anormal"},
            { name: "P5K - Pág. 103", text: "Prueba de frenos Anormal"},
            //LZB
            { name: "FF7I - Pág. 106", text: "En la línea Alta Velocidad Madrid-Sevilla ordena parar ante ella sin rebasarla. Para los trenes con LZB, la señalización en cabina prevalece sobre la indicación de la señal."},
            //RAM
            { name: "FF10C - Pág. 107", text: "Paso a nivel protegido"},
            { name: "FF10C - Pág. 107", text: "Paso a nivel protegido"},
            { name: "FF11B - Pág. 108", text: "Paso a nivel sin protección"},
            { name: "FI17A - Pág. 108", text: "Indicadora de precaución luminosa:"},
            { name: "FI17B - Pág. 108", text: "Indicadora de precaución (pantalla)"},
            { name: "FI12A - Pág. 109", text: "Indicador de conexión al circuito telefónico: poste dotado de conector a la intemperie."},
            { name: "FI12B - Pág. 109", text: "Indicador de conexión al circuito telefónico: poste no dotado de conector a la intemperie. La flecha indica la dirección del poste más próximo."},
            { name: "FI15AÑ - Pág. 109", text: "Indica proximidad de un desvío en plena vía a tomar de talón a la distancia indicada."},
            { name: "FI15AO - Pág. 109", text: "Indica proximidad de un desvío en plena vía a tomar de punta a la distancia indicada."},
            { name: "FI15AP - Pág. 109", text: "Indica El punto en el que el maquinista debe iniciar el frenado del tren, en las condiciones que se determinen por Consigna."},
            { name: "FI15AQ - Pág. 109", text: "Indica el punto en que finaliza el circuito de vía que afecta a las agujas y que debe quedar libre en las maniobras que afecten a la aguja o agujas que señala."},
            //PERPIGNAN
            { name: "SIB1 - Pág. 112", text: "Señal de bloqueo. Protección no franqueable."},
            { name: "SIB2 - Pág. 112", text: "Señal de bloqueo. Protección franqueable."},
            { name: "SIB3 - Pág. 112", text: "Señal de bloqueo. Señal de límite de cantón. Delimita simultáneamente cantones de ERTMS 1 y ERTMS 2."},
            { name: "SIB4 - Pág. 112", text: "Señal de bloqueo. Señal de límite de cantón. Delimita simultáneamente cantones de ERTMS 1 y ERTMS 2."},
            { name: "SIB5 - Pág. 112", text: "Señal de bloqueo. Señal de límite de cantón. Delimita cantones de ERTMS 2."},
            { name: "SIB6 - Pág. 113", text: "Señal de bloqueo. Señal de fin de autorización de movimiento. Ordena detenerse antes de la primera baliza del grupo de señal."},
            { name: "SIB7 - Pág. 113", text: "Señal de bloqueo. Señal de fin de autorización de movimiento. Ordena detenerse antes de la primera baliza del grupo de señal."},
            { name: "SIB8 - Pág. 113", text: "Señal de bloqueo. Señal de fin de autorización de movimiento. Ordena la detención lo antes posible."},
            { name: "SIB9 - Pág. 113", text: "Señal de bloqueo. Señal de marcha a la vista."},
            { name: "SIB10 - Pág. 113", text: "Señal de bloqueo. Señal de marcha a la vista."},
            { name: "SIB11 - Pág. 113", text: "Señal de bloqueo. Señal de marcha a la vista."},
            { name: "SIB12 - Pág. 113", text: "Señal de bloqueo. Señal de marcha a la vista."},
            { name: "SIM1 - Pág. 114", text: "Señal de marcha de maniobra."},
            { name: "SIM2 - Pág. 114", text: "Indica el punto máximo que no se puede rebasar cuando se ha presentado la señal de marcha de maniobras (modo Shunting)."},
            { name: "SII1 - Pág. 114", text: "Señal de las instalaciones. Hito kilométrico y hectométrico. Indica el punto kilométrico y la vía."},
            { name: "SII2 - Pág. 115", text: "Señal de las instalaciones. Señal de limitación de velocidad. Anuncio permanente."},
            { name: "SII3 - Pág. 115", text: "Señal de las instalaciones. Señal de limitación de velocidad. Inicio permanente."},
            { name: "SII4 - Pág. 115", text: "Señal de las instalaciones. Señal de limitación de velocidad. Fin permanente."},
            { name: "SII5 - Pág. 115", text: "Señal de las instalaciones. Señal de limitación de velocidad. Anuncio temporal."},
            { name: "SII6 - Pág. 115", text: "Señal de las instalaciones. Señal de limitación de velocidad. Inicio temporal."},
            { name: "SII7 - Pág. 115", text: "Señal de las instalaciones. Señal de limitación de velocidad. Fin temporal."},
            { name: "SII8 - Pág. 115", text: "Señal de las instalaciones. Señal de final de vía. Anuncio. Ordena prepararse para detener el tren antes de la posterior señal ejecutiva de Final de Vía."},
            { name: "SII9 - Pág. 115", text: "Señal de las instalaciones. Señal de final de vía. Ejecución. Ordena detención sin rebasarla"},
            { name: "SII10 - Pág. 116", text: "Señal de las instalaciones. Señal de final de la catenaria. Indica el punto límite que los vehículos de tracción eléctrica no deben rebasar."}
            
        ]
        var errorsHistory = [];
        var verSolucion = false;
        var signsAnswered=0;
        var wrongAnswers=0;
        var totalSigns=0;
        var signsQuestionnaire = [];
        var testSelection="";

        checkHistoryCookie();

        function start(button) {
            button.style.display="none";
            button.disabled = true;
            signsAnswered=0;
            wrongAnswers=0;
            initQuestionnaire();
            toggle(document.getElementById("questions"));
            loadSign();
        }
        function initQuestionnaire() {
            var form = document.getElementById("init_questionnaire_form");
            for(var i=0; i<form.children.length;i++){
                if(form.children[i].id=="merc_pel" && form.children[i].checked == true){
                    testSelection=mercPelFolderName;
                    for(var i=0;i<mercPelSigns.length;i++){
                        signsQuestionnaire.push(mercPelSigns[i]);
                    }
                    break;
                }
                else if(form.children[i].id=="fund" && form.children[i].checked == true){
                    testSelection="fund"
                    for(var i=0;i<fundSings.length;i++){
                        signsQuestionnaire.push(fundSings[i]);
                    }
                    break;
                }
                else if(form.children[i].id=="transitorias" && form.children[i].checked == true){
                    testSelection="transitorias"
                    for(var i=0;i<transitoriaSigns.length;i++){
                        signsQuestionnaire.push(transitoriaSigns[i]);
                    }
                    break;
                }
            }
            totalSigns = signsQuestionnaire.length;
        }
        function restart() {
            document.getElementById("startButton").disabled = false;
            document.getElementById("startButton").style.display="block";
            document.getElementById("questionnaire-results").style.display="none";
            toggleSolution();
        }
        function toggleSolution() {
            toggle(document.getElementById("solucion"));
            toggle(document.getElementById("resultButtons"));
        }
        function toggle(elem) {
            if(elem.style.display == "none"){
                elem.style.display ="block";
            }
            else{
                elem.style.display ="none";
            }
        }
        function next(correctAnswer) {
            signsAnswered++;
            if(!correctAnswer){
                wrongAnswers++;
                var signName = document.getElementById("sign-name").innerHTML;
                
                var foundInHistory=false;
                for(var i=0; i<errorsHistory.length; i++){
                    if(errorsHistory[i].name == signName){
                        errorsHistory[i].errorCount++;
                        foundInHistory = true;
                        break;
                    }
                }
                if(foundInHistory == false){
                    errorsHistory.push({ name: signName, errorCount: 1});
                }
                updateHistoryCookie();
            }
            if(signsAnswered<totalSigns){
                loadSign();
                toggleSolution();
            }
            else{
                document.getElementById("questions").style.display="none";
                showQuestionnaireResults();
              
            }
        }
        function showQuestionnaireResults() {
            document.getElementById("questionnaire-results").style.display="block";
            var rightAnswers = totalSigns - wrongAnswers;
            document.getElementById("questionnaire-right-answers").innerHTML = rightAnswers + "(" + (rightAnswers*100/totalSigns).toFixed(2) + "%)";
            document.getElementById("questionnaire-wrong-answers").innerHTML = wrongAnswers;
            document.getElementById("questionnaire-total-answers").innerHTML = totalSigns;
        }

        function loadSign() {
            var randomIndex = Math.floor(Math.random() * signsQuestionnaire.length)
            var randomSign = signsQuestionnaire[randomIndex];
            var signName = randomSign.name;
            var src ="img/"+ testSelection + "/" +randomSign.name+".jpg";
            document.getElementById("img-senal").src = src;
            document.getElementById("solucion").innerHTML = randomSign.text;
            document.getElementById("sign-name").innerHTML = randomSign.name;

            var anySignsWithSameName = true;
            var i=0;
            while (i<signsQuestionnaire.length) {
                if(signsQuestionnaire[i].name === signName) {
                    signsQuestionnaire.splice(i,1);
                    i=0; //reset search
                }
                i++;
            }
        }

        document.getElementById("uploadHistory").addEventListener('change', readSingleFile, false);
        function readSingleFile(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                var contents = e.target.result;
                errorsHistory = JSON.parse(contents)
                updateHistoryCookie();
                var totalErrors=0;
                for(var i=0; i<errorsHistory.length; i++){
                    totalErrors += errorsHistory[i].errorCount;
                }
                alert("Historial cargado: " + totalErrors + " preguntas falladas hasta ahora.")
            };
            reader.readAsText(file);
        }
        function downloadHistory() {
            download(JSON.stringify(errorsHistory), 'practicar-señales-historico.txt', 'text/plain');
        }
        function download(content, fileName, contentType) {
            var a = document.createElement("a");
            var file = new Blob([content], {type: contentType});
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }
        function updateHistoryCookie() {
            var d = new Date();
            var year = d.getFullYear();
            var month = d.getMonth();
            var day = d.getDate();
            var c = new Date(year + 1, month, day);
            document.cookie = 'errorHistory='+ JSON.stringify(errorsHistory) +';expires=' + c + ';Secure';
        }
        function checkHistoryCookie() {
            var cookie = getCookie("errorHistory");
            if(cookie == "") { return; }

            var history = JSON.parse(cookie);
            if(history == ""){ return; }
            for(var i=0; i<history.length;i++){
                //Load historic errors
                errorsHistory.push({ name: history[i].name, errorCount: history[i].errorCount})

                for(var j=0; j<signsQuestionnaire.length;j++){
                    if(signsQuestionnaire[j].name === history[i].name){
                        //Add failed question to the pool for each time the user failed it, multiplying probability to get that question
                        for(var k=0;k<history[i].errorCount;k++){
                            signsQuestionnaire.push(signs[j]);
                        }
                        
                    }
                }
            }
        }
        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for(var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    </script>
</html>